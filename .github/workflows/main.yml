name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
      RAILWAY_PROJECT_TOKEN_D: ${{ secrets.RAILWAY_PROJECT_TOKEN_D }}

    permissions:
      contents: read
      packages: write   # REQUIRED for pushing to GHCR

    steps:
      # 1ï¸âƒ£ Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # 3ï¸âƒ£ Install dependencies
      - name: Install dependencies
        run: npm install

      # 4ï¸âƒ£ Run tests (dummy test script is OK for assignment)
      - name: Run tests
        run: npm test

      # 5ï¸âƒ£ Log in to GitHub Container Registry
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}
        

      # 6ï¸âƒ£ Build Docker image
      - name: Build Docker image
        run: |
          docker build \
            -t ghcr.io/${{ github.repository }}/node-docker-sample:latest .

      # 7ï¸âƒ£ Push Docker image to GHCR
      - name: Push Docker image
        run: |
          docker push ghcr.io/${{ github.repository }}/node-docker-sample:latest

      # 8ï¸âƒ£ Install Railway CLI
      - name: Install Railway CLI
        run: npm install -g @railway/cli

      # 9ï¸âƒ£ Restore Railway CLI Auth
      #- name: Restore Railway CLI Auth
      #  run: |
      #    mkdir -p ~/.config/railway
      #    echo $RAILWAY_CLI_AUTH |base64 -d > ~/.config/railway/config.json

        
    
      # Link Railway Project
      - name: Link Railway project
        run: railway link -p $RAILWAY_PROJECT_ID
        
      # ðŸ”Ÿ Deploy to Railway (existing empty service)
      #- name: Deploy to Railway
      #  run: railway up --detach
      #  env:
      #    RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      #    RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
      #- name: Deploy to Railway
      #  run: |
      #    railway up \
      #      --service-id ${{ secrets.RAILWAY_SERVICE_ID }} \
      #      --detach
